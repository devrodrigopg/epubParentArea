{"version":3,"names":["React","useContext","useEffect","useState","FileSystem","LoadingFile","View","useInjectWebVieWVariables","ReaderContext","defaultTheme","initialTheme","isURL","getSourceType","getSourceName","SourceType","isFsUri","jszip","epubjs","Reader","_ref","src","width","height","initialLocations","renderLoadingFileComponent","props","createElement","_extends","fileSystem","useFileSystem","rest","downloadFile","size","fileSize","progress","downloadProgress","success","downloadSuccess","error","downloadError","setIsLoading","isLoading","injectWebVieWVariables","template","setTemplate","templateUrl","setTemplateUrl","allowedUris","setAllowedUris","jszipFileUri","documentDirectory","epubjsFileUri","writeAsStringAsync","e","Error","sourceType","isExternalSource","isSrcInFs","BASE64","type","book","theme","locations","enableSelection","BINARY","sourceName","OPF","EPUB","uri","bookFileUri","saveTemplateFileToDoc","content","fileUri","templateUri"],"sources":["Reader.tsx"],"sourcesContent":["import React, { useContext, useEffect, useState } from 'react';\nimport * as FileSystem from 'expo-file-system';\nimport { LoadingFile } from './utils/LoadingFile';\nimport type { ReaderProps } from './types';\nimport { View } from './View';\nimport { useInjectWebVieWVariables } from './hooks/useInjectWebviewVariables';\nimport { ReaderContext, defaultTheme as initialTheme } from './context';\nimport { isURL } from './utils/isURL';\nimport { getSourceType } from './utils/getSourceType';\nimport { getSourceName } from './utils/getPathname';\nimport { SourceType } from './utils/enums/source-type.enum';\nimport { isFsUri } from './utils/isFsUri';\nimport jszip from './jszip';\nimport epubjs from './epubjs';\n\n// ...\nexport function Reader({\n  src,\n  width,\n  height,\n  defaultTheme = initialTheme,\n  initialLocations,\n  renderLoadingFileComponent = (props) => (\n    <LoadingFile {...props} width={width} height={height} />\n  ),\n  fileSystem: useFileSystem,\n  ...rest\n}: ReaderProps) {\n  const {\n    downloadFile,\n    size: fileSize,\n    progress: downloadProgress,\n    success: downloadSuccess,\n    error: downloadError,\n  } = useFileSystem();\n\n  const { setIsLoading, isLoading } = useContext(ReaderContext);\n  const { injectWebVieWVariables } = useInjectWebVieWVariables();\n  const [template, setTemplate] = useState<string | null>(null);\n  const [templateUrl, setTemplateUrl] = useState<string | null>(null);\n  const [allowedUris, setAllowedUris] = useState<string | null>(null);\n\n  useEffect(() => {\n    (async () => {\n      setIsLoading(true);\n\n      const jszipFileUri = `${FileSystem.documentDirectory}jszip.min.js`;\n      const epubjsFileUri = `${FileSystem.documentDirectory}epub.min.js`;\n\n      try {\n        await FileSystem.writeAsStringAsync(jszipFileUri, jszip);\n      } catch (e) {\n        throw new Error('failed to write jszip js file');\n      }\n\n      try {\n        await FileSystem.writeAsStringAsync(epubjsFileUri, epubjs);\n      } catch (e) {\n        throw new Error('failed to write epubjs js file');\n      }\n\n      setAllowedUris(`${jszipFileUri},${epubjsFileUri}`);\n\n      if (src) {\n        const sourceType = getSourceType(src);\n        const isExternalSource = isURL(src);\n        const isSrcInFs = isFsUri(src);\n\n        if (!sourceType) {\n          throw new Error(`Invalid source type: ${src}`);\n        }\n\n        if (!isExternalSource) {\n          if (isSrcInFs) {\n            setAllowedUris(`${src}${jszipFileUri},${epubjsFileUri}`);\n          }\n          if (sourceType === SourceType.BASE64) {\n            setTemplate(\n              injectWebVieWVariables({\n                jszip: jszipFileUri,\n                epubjs: epubjsFileUri,\n                type: SourceType.BASE64,\n                book: src,\n                theme: defaultTheme,\n                locations: initialLocations,\n                enableSelection: true,\n              })\n            );\n\n            setIsLoading(false);\n          } else {\n            setTemplate(\n              injectWebVieWVariables({\n                jszip: jszipFileUri,\n                epubjs: epubjsFileUri,\n                type: SourceType.BINARY,\n                book: src,\n                theme: defaultTheme,\n                locations: initialLocations,\n                enableSelection: true,\n              })\n            );\n\n            setIsLoading(false);\n          }\n        }\n\n        if (isExternalSource) {\n          const sourceName = getSourceName(src);\n\n          if (!sourceName) {\n            throw new Error(`Invalid source name: ${src}`);\n          }\n\n          if (sourceType === SourceType.OPF || sourceType === SourceType.EPUB) {\n            setTemplate(\n              injectWebVieWVariables({\n                jszip: jszipFileUri,\n                epubjs: epubjsFileUri,\n                type: sourceType,\n                book: src,\n                theme: defaultTheme,\n                locations: initialLocations,\n                enableSelection: true,\n              })\n            );\n\n            setIsLoading(false);\n          } else {\n            const { uri: bookFileUri } = await downloadFile(src, sourceName);\n\n            if (!bookFileUri) throw new Error(\"Couldn't download book\");\n\n            setAllowedUris(`${bookFileUri},${jszipFileUri},${epubjsFileUri}`);\n\n            setTemplate(\n              injectWebVieWVariables({\n                jszip: jszipFileUri,\n                epubjs: epubjsFileUri,\n                type: sourceType,\n                book: bookFileUri,\n                theme: defaultTheme,\n                locations: initialLocations,\n                enableSelection: true,\n              })\n            );\n\n            setIsLoading(false);\n          }\n        }\n      }\n    })();\n  }, [\n    defaultTheme,\n    downloadFile,\n    initialLocations,\n    injectWebVieWVariables,\n    setIsLoading,\n    src,\n  ]);\n\n  useEffect(() => {\n    const saveTemplateFileToDoc = async () => {\n      try {\n        if (template) {\n          const content = template;\n\n          const fileUri = `${FileSystem.documentDirectory}index.html`;\n          await FileSystem.writeAsStringAsync(fileUri, content);\n          setTemplateUrl(fileUri);\n        }\n      } catch (error) {\n        throw new Error('Error saving index.html file:');\n      }\n    };\n    if (template) {\n      saveTemplateFileToDoc();\n    }\n  }, [template]);\n\n  if (isLoading) {\n    return renderLoadingFileComponent({\n      fileSize,\n      downloadProgress,\n      downloadSuccess,\n      downloadError,\n    });\n  }\n\n  if (!templateUrl || !allowedUris) {\n    return renderLoadingFileComponent({\n      fileSize,\n      downloadProgress,\n      downloadSuccess,\n      downloadError,\n    });\n  }\n  return (\n    <View\n      templateUri={templateUrl}\n      allowedUris={allowedUris}\n      width={width}\n      height={height}\n      {...rest}\n    />\n  );\n}\n"],"mappings":"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"}