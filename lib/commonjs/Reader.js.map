{"version":3,"names":["_react","_interopRequireWildcard","require","FileSystem","_LoadingFile","_View","_useInjectWebviewVariables","_context","_isURL","_getSourceType","_getPathname","_sourceType","_isFsUri","_jszip","_interopRequireDefault","_epubjs","obj","__esModule","default","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","_extends","assign","bind","target","i","arguments","length","source","apply","Reader","_ref","src","width","height","defaultTheme","initialTheme","initialLocations","renderLoadingFileComponent","props","createElement","LoadingFile","fileSystem","useFileSystem","rest","downloadFile","size","fileSize","progress","downloadProgress","success","downloadSuccess","error","downloadError","setIsLoading","isLoading","useContext","ReaderContext","injectWebVieWVariables","useInjectWebVieWVariables","template","setTemplate","useState","templateUrl","setTemplateUrl","allowedUris","setAllowedUris","useEffect","jszipFileUri","documentDirectory","epubjsFileUri","writeAsStringAsync","jszip","e","Error","epubjs","sourceType","getSourceType","isExternalSource","isURL","isSrcInFs","isFsUri","SourceType","BASE64","type","book","theme","locations","enableSelection","BINARY","sourceName","getSourceName","OPF","EPUB","uri","bookFileUri","saveTemplateFileToDoc","content","fileUri","View","templateUri"],"sources":["Reader.tsx"],"sourcesContent":["import React, { useContext, useEffect, useState } from 'react';\nimport * as FileSystem from 'expo-file-system';\nimport { LoadingFile } from './utils/LoadingFile';\nimport type { ReaderProps } from './types';\nimport { View } from './View';\nimport { useInjectWebVieWVariables } from './hooks/useInjectWebviewVariables';\nimport { ReaderContext, defaultTheme as initialTheme } from './context';\nimport { isURL } from './utils/isURL';\nimport { getSourceType } from './utils/getSourceType';\nimport { getSourceName } from './utils/getPathname';\nimport { SourceType } from './utils/enums/source-type.enum';\nimport { isFsUri } from './utils/isFsUri';\nimport jszip from './jszip';\nimport epubjs from './epubjs';\n\n// ...\nexport function Reader({\n  src,\n  width,\n  height,\n  defaultTheme = initialTheme,\n  initialLocations,\n  renderLoadingFileComponent = (props) => (\n    <LoadingFile {...props} width={width} height={height} />\n  ),\n  fileSystem: useFileSystem,\n  ...rest\n}: ReaderProps) {\n  const {\n    downloadFile,\n    size: fileSize,\n    progress: downloadProgress,\n    success: downloadSuccess,\n    error: downloadError,\n  } = useFileSystem();\n\n  const { setIsLoading, isLoading } = useContext(ReaderContext);\n  const { injectWebVieWVariables } = useInjectWebVieWVariables();\n  const [template, setTemplate] = useState<string | null>(null);\n  const [templateUrl, setTemplateUrl] = useState<string | null>(null);\n  const [allowedUris, setAllowedUris] = useState<string | null>(null);\n\n  useEffect(() => {\n    (async () => {\n      setIsLoading(true);\n\n      const jszipFileUri = `${FileSystem.documentDirectory}jszip.min.js`;\n      const epubjsFileUri = `${FileSystem.documentDirectory}epub.min.js`;\n\n      try {\n        await FileSystem.writeAsStringAsync(jszipFileUri, jszip);\n      } catch (e) {\n        throw new Error('failed to write jszip js file');\n      }\n\n      try {\n        await FileSystem.writeAsStringAsync(epubjsFileUri, epubjs);\n      } catch (e) {\n        throw new Error('failed to write epubjs js file');\n      }\n\n      setAllowedUris(`${jszipFileUri},${epubjsFileUri}`);\n\n      if (src) {\n        const sourceType = getSourceType(src);\n        const isExternalSource = isURL(src);\n        const isSrcInFs = isFsUri(src);\n\n        if (!sourceType) {\n          throw new Error(`Invalid source type: ${src}`);\n        }\n\n        if (!isExternalSource) {\n          if (isSrcInFs) {\n            setAllowedUris(`${src}${jszipFileUri},${epubjsFileUri}`);\n          }\n          if (sourceType === SourceType.BASE64) {\n            setTemplate(\n              injectWebVieWVariables({\n                jszip: jszipFileUri,\n                epubjs: epubjsFileUri,\n                type: SourceType.BASE64,\n                book: src,\n                theme: defaultTheme,\n                locations: initialLocations,\n                enableSelection: true,\n              })\n            );\n\n            setIsLoading(false);\n          } else {\n            setTemplate(\n              injectWebVieWVariables({\n                jszip: jszipFileUri,\n                epubjs: epubjsFileUri,\n                type: SourceType.BINARY,\n                book: src,\n                theme: defaultTheme,\n                locations: initialLocations,\n                enableSelection: true,\n              })\n            );\n\n            setIsLoading(false);\n          }\n        }\n\n        if (isExternalSource) {\n          const sourceName = getSourceName(src);\n\n          if (!sourceName) {\n            throw new Error(`Invalid source name: ${src}`);\n          }\n\n          if (sourceType === SourceType.OPF || sourceType === SourceType.EPUB) {\n            setTemplate(\n              injectWebVieWVariables({\n                jszip: jszipFileUri,\n                epubjs: epubjsFileUri,\n                type: sourceType,\n                book: src,\n                theme: defaultTheme,\n                locations: initialLocations,\n                enableSelection: true,\n              })\n            );\n\n            setIsLoading(false);\n          } else {\n            const { uri: bookFileUri } = await downloadFile(src, sourceName);\n\n            if (!bookFileUri) throw new Error(\"Couldn't download book\");\n\n            setAllowedUris(`${bookFileUri},${jszipFileUri},${epubjsFileUri}`);\n\n            setTemplate(\n              injectWebVieWVariables({\n                jszip: jszipFileUri,\n                epubjs: epubjsFileUri,\n                type: sourceType,\n                book: bookFileUri,\n                theme: defaultTheme,\n                locations: initialLocations,\n                enableSelection: true,\n              })\n            );\n\n            setIsLoading(false);\n          }\n        }\n      }\n    })();\n  }, [\n    defaultTheme,\n    downloadFile,\n    initialLocations,\n    injectWebVieWVariables,\n    setIsLoading,\n    src,\n  ]);\n\n  useEffect(() => {\n    const saveTemplateFileToDoc = async () => {\n      try {\n        if (template) {\n          const content = template;\n\n          const fileUri = `${FileSystem.documentDirectory}index.html`;\n          await FileSystem.writeAsStringAsync(fileUri, content);\n          setTemplateUrl(fileUri);\n        }\n      } catch (error) {\n        throw new Error('Error saving index.html file:');\n      }\n    };\n    if (template) {\n      saveTemplateFileToDoc();\n    }\n  }, [template]);\n\n  if (isLoading) {\n    return renderLoadingFileComponent({\n      fileSize,\n      downloadProgress,\n      downloadSuccess,\n      downloadError,\n    });\n  }\n\n  if (!templateUrl || !allowedUris) {\n    return renderLoadingFileComponent({\n      fileSize,\n      downloadProgress,\n      downloadSuccess,\n      downloadError,\n    });\n  }\n  return (\n    <View\n      templateUri={templateUrl}\n      allowedUris={allowedUris}\n      width={width}\n      height={height}\n      {...rest}\n    />\n  );\n}\n"],"mappings":"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"}